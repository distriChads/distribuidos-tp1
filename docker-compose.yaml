name: tp1
services:
  rabbitmq:
    image: rabbitmq:4.0-management
    ports:
      - 5672:5672
      - 15672:15672
    networks:
      movies_net:
        ipv4_address: 172.25.125.10

  filter-after-2000:
    build:
      context: .
      dockerfile: filters/filter_after_2000/Dockerfile
    volumes:
      - ./filters/filter_after_2000/main/config.yaml:/config.yaml
    container_name: filter-after-2000
    image: filter-after-2000:latest
    entrypoint: ./filter_after_2000
    networks:
      - movies_net
    depends_on:
      - rabbitmq

  filter-argentina:
    build:
      context: .
      dockerfile: filters/filter_argentina/Dockerfile
    volumes:
      - ./filters/filter_argentina/main/config.yaml:/config.yaml
    container_name: filter-argentina
    image: filter-argentina:latest
    entrypoint: ./filter_argentina
    networks:
      - movies_net
    depends_on:
      - rabbitmq

  filter-spain-2000:
    build:
      context: .
      dockerfile: filters/filter_spain_2000/Dockerfile
    volumes:
      - ./filters/filter_spain_2000/main/config.yaml:/config.yaml
    container_name: filter-spain-2000
    image: filter-spain-2000:latest
    entrypoint: ./filter_spain_2000
    networks:
      - movies_net
    depends_on:
      - rabbitmq

  filter-only-one-country:
    build:
      context: .
      dockerfile: filters/filter_only_one_country/Dockerfile
    volumes:
      - ./filters/filter_only_one_country/main/config.yaml:/config.yaml
    container_name: filter-only-one-country
    image: filter-only-one-country:latest
    entrypoint: ./filter_only_one_country
    networks:
      - movies_net
    depends_on:
      - rabbitmq

  group_by_country_sum:
    build:
      context: .
      dockerfile: group_by/group_by_country_sum/Dockerfile
    volumes:
      - ./group_by/group_by_country_sum/main/config.yaml:/config.yaml
    container_name: group_by_country_sum
    image: group_by_country_sum:latest
    entrypoint: ./group_by_country_sum
    networks:
      - movies_net
    depends_on:
      - rabbitmq

  top_five_country_budget:
    build:
      context: .
      dockerfile: topn/top_five_country_budget/Dockerfile
    volumes:
      - ./topn/top_five_country_budget/main/config.yaml:/config.yaml
    container_name: top_five_country_budget
    image: top_five_country_budget:latest
    entrypoint: ./top_five_country_budget
    networks:
      - movies_net
    depends_on:
      - rabbitmq
      
  join_movie_credits:
    build:
      context: .
      dockerfile: join/join_movie_credits/Dockerfile
    volumes:
      - ./join/join_movie_credits/main/config.yaml:/config.yaml
    container_name: join_movie_credits
    image: join_movie_credits:latest
    entrypoint: ./join_movie_credits
    networks:
      - movies_net
    depends_on:
      - rabbitmq

  join_movie_ratings:
    build:
      context: .
      dockerfile: join/join_movie_ratings/Dockerfile
    volumes:
      - ./join/join_movie_ratings/main/config.yaml:/config.yaml
    container_name: join_movie_ratings
    image: join_movie_ratings:latest
    entrypoint: ./join_movie_ratings
    networks:
      - movies_net
    depends_on:
      - rabbitmq

  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    volumes:
      - ./server/main.py:/app/server/main.py
    container_name: server
    image: server:latest
    entrypoint: ./server/main.py
    networks:
      - movies_net
    depends_on:
      - rabbitmq
      

networks:
  movies_net:
    ipam:
      driver: default
      config:
        - subnet: 172.25.125.0/24
